FROM registry.redhat.io/rhel9/rhel-bootc:latest

# configure an insecure local registry
RUN  mkdir -p /etc/containers/registries.conf.d
COPY 999-local-registry.conf /etc/containers/registries.conf.d/

# install and configure a graphical environment with FlightGear
RUN --mount=type=bind,relabel=shared,source=fg-rpms.tgz,target=/tmp/fg-rpms.tgz \
       tar zxf /tmp/fg-rpms.tgz \
    && cd flightgear-rpms \
    && dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm \
    && dnf -y install --enablerepo=codeready-builder-for-rhel-9-x86_64-rpms *.rpm \
           gnome-shell gnome-kiosk gnome-kiosk-script-session firefox \
    && cd / \
    && rm -fr flightgear-rpms \
    && systemctl set-default graphical.target \
    && useradd -m kiosk \
    && passwd -d kiosk \
    && sed -i.bak "/^\[daemon\]/aAutomaticLoginEnable=True\nAutomaticLogin=kiosk" /etc/gdm/custom.conf \
    && mkdir -p /home/kiosk/.local/bin \
    && printf '#!/bin/sh\nfirefox -kiosk https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux/image-mode\nsleep 1.0\nexec "$0" "$@"' \
           > /home/kiosk/.local/bin/gnome-kiosk-script \
    && chown -R kiosk: /home/kiosk \
    && chmod +x /home/kiosk/.local/bin/gnome-kiosk-script \
    && printf '[User]\nSession=gnome-kiosk-script\nSystemAccount=false' \
           > /var/lib/AccountsService/users/kiosk
