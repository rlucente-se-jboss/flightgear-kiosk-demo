FROM registry.redhat.io/rhel9/rhel-bootc:latest

# configure an insecure local registry
RUN  mkdir -p /etc/containers/registries.conf.d
COPY 999-local-registry.conf /etc/containers/registries.conf.d/

# install FlightGear, web browser, and kiosk UI
RUN --mount=type=bind,relabel=shared,source=fg-rpms.tgz,target=/tmp/fg-rpms.tgz \
       tar zxf /tmp/fg-rpms.tgz \
    && cd flightgear-rpms \
    && dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm \
    && dnf -y install --enablerepo=codeready-builder-for-rhel-9-x86_64-rpms *.rpm \
           gnome-shell gnome-kiosk gnome-kiosk-script-session firefox unzip \
    && rm -fr /flightgear-rpms \
    && systemctl set-default graphical.target

# add kiosk mode content under /usr/share/kiosk-mode since /var/home
# cannot be updated after initial install
RUN    useradd -m kiosk \
    && passwd -d kiosk \
    && mkdir -p /usr/share/kiosk-mode/bin \
                /usr/share/kiosk-mode/downloads \
    && touch /usr/share/kiosk-mode/fgdemo.conf \
    && printf '#!/bin/sh\nfirefox -kiosk https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux/image-mode\nsleep 1.0\nexec "$0" "$@"' \
           > /usr/share/kiosk-mode/bin/gnome-kiosk-script \
    && chmod +x /usr/share/kiosk-mode/bin/gnome-kiosk-script \
    && chown -R kiosk: /usr/share/kiosk-mode

# configure automatic logins and kiosk mode
RUN    sed -i.bak "/^\[daemon\]/aAutomaticLoginEnable=True\nAutomaticLogin=kiosk" /etc/gdm/custom.conf \
    && printf '[User]\nSession=gnome-kiosk-script\nSystemAccount=false' \
           > /var/lib/AccountsService/users/kiosk

# soft-link kiosk user to kiosk-mode content
RUN    rm -fr /home/kiosk/Downloads \
    && ln -s /usr/share/kiosk-mode/downloads /home/kiosk/Downloads \
    && ln -s /usr/share/kiosk-mode/fgdemo.conf /home/kiosk/ \
    && mkdir -p /home/kiosk/.local/bin \
    && ln -s /usr/share/kiosk-mode/bin/gnome-kiosk-script /home/kiosk/.local/bin/ \
    && chown -R kiosk: /home/kiosk

